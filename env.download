
import React from 'react';
import { Printer, ArrowLeft, Calendar } from 'lucide-react';
import { AreaData } from '../types';
import { AREA_CONFIGS, getIcon } from '../constants';

interface PlanPreviewProps {
  data: Record<string, AreaData>;
  wardName: string;
  onBack: () => void;
}

const PlanPreview: React.FC<PlanPreviewProps> = ({ data, wardName, onBack }) => {
  
  const handlePrint = () => {
    // Se llama directamente a window.print() sin setTimeout
    // Esto asegura que el navegador reconozca la acción del usuario y no la bloquee.
    window.print();
  };

  const handleBack = () => {
    onBack();
  };

  // Helper para estilos con degradados vibrantes sin sombras
  const getAreaStyles = (color: string) => {
    switch (color) {
      case 'orange': return {
        headerBg: 'bg-gradient-to-br from-orange-400 to-red-500',
        titleText: 'text-white',
        iconBg: 'bg-white/20 text-white',
        divider: 'border-orange-100',
        cardBorder: 'border-orange-100'
      };
      case 'amber': return {
        headerBg: 'bg-gradient-to-br from-amber-400 to-orange-500', 
        titleText: 'text-white',
        iconBg: 'bg-white/20 text-white',
        divider: 'border-amber-100',
        cardBorder: 'border-amber-100'
      };
      case 'sky': return {
        headerBg: 'bg-gradient-to-br from-sky-400 to-blue-600', 
        titleText: 'text-white',
        iconBg: 'bg-white/20 text-white',
        divider: 'border-sky-100',
        cardBorder: 'border-sky-100'
      };
      case 'emerald': return {
        headerBg: 'bg-gradient-to-br from-emerald-400 to-green-600', 
        titleText: 'text-white',
        iconBg: 'bg-white/20 text-white',
        divider: 'border-emerald-100',
        cardBorder: 'border-emerald-100'
      };
      default: return {
        headerBg: 'bg-slate-800',
        titleText: 'text-white',
        iconBg: 'bg-white/20 text-white',
        divider: 'border-slate-200',
        cardBorder: 'border-slate-200'
      };
    }
  };

  return (
    <div className="min-h-screen bg-slate-900 flex flex-col items-center py-8 print:bg-white print:min-h-0 print:h-auto print:block print:p-0">
      
      {/* Barra de herramientas (No se imprime) */}
      <div className="w-full max-w-4xl px-4 mb-10 flex justify-between items-center print:hidden">
        <button 
          onClick={handleBack}
          type="button"
          className="flex items-center gap-2 px-4 py-2 bg-slate-800 text-slate-300 rounded-full shadow-sm border border-slate-700 hover:bg-slate-700 hover:text-white hover:border-slate-600 transition-all font-medium cursor-pointer"
        >
          <ArrowLeft size={18} />
          Volver a editar
        </button>

        <button 
          onClick={handlePrint}
          type="button"
          className="flex items-center gap-2 px-6 py-2 bg-white text-slate-900 rounded-full shadow-md hover:bg-slate-200 transition-all font-medium cursor-pointer"
        >
          <Printer size={18} />
          Imprimir Plan
        </button>
      </div>

      {/* Contenido Principal */}
      <div className="w-full max-w-4xl px-4 md:px-0 print:w-full print:max-w-none print:px-0 animate-in fade-in duration-500">
        
        {/* Encabezado Principal (Estilo Interfaz) */}
        <header className="text-center mb-16 print:mb-8">
            <h1 className="text-4xl md:text-6xl font-black text-white uppercase tracking-tight leading-none mb-2 print:text-black">
              PLAN MISIONAL
            </h1>
            <h2 className="text-sm md:text-base font-light text-slate-400 uppercase tracking-[0.2em] print:text-slate-600">
              {wardName}
            </h2>
        </header>

        {/* Lista de Áreas */}
        <div className="space-y-8">
          {Object.values(AREA_CONFIGS).map((config) => {
            // Filtrar solo las metas NO completadas
            const activeItems = (data[config.id]?.items || []).filter(item => !item.isCompleted);
            
            // Si no hay metas pendientes, no mostramos el área
            if (activeItems.length === 0) return null;

            const styles = getAreaStyles(config.color);

            return (
              <section key={config.id} className="break-inside-avoid">
                
                {/* Tarjeta del Área */}
                <div className={`bg-white rounded-3xl shadow-sm border ${styles.cardBorder} overflow-hidden print:shadow-none print:border print:border-gray-300 print:rounded-xl`}>
                    
                    {/* Encabezado del Área con Degradado */}
                    <div className={`${styles.headerBg} p-5 flex items-center gap-4 print:py-3 print:px-4`}>
                        <div className={`p-3 rounded-xl ${styles.iconBg} backdrop-blur-md shadow-inner print:p-2 print:border print:border-slate-200 print:text-black print:bg-transparent`}>
                            {getIcon(config.iconName, "w-8 h-8 print:w-6 print:h-6")}
                        </div>
                        <h3 className={`text-xl md:text-2xl font-bold uppercase tracking-wide ${styles.titleText} print:text-lg print:text-black`}>
                            {config.title}
                        </h3>
                    </div>

                    {/* Lista de Metas */}
                    <div className="p-6 md:p-8 print:p-4">
                        {activeItems.map((item, index) => (
                            <div 
                            key={item.id} 
                            className={`mb-6 pb-6 ${index !== activeItems.length - 1 ? `border-b ${styles.divider}` : ''} break-inside-avoid print:mb-4 print:pb-4`}
                            >
                            <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">
                                
                                {/* Columna: QUÉ */}
                                <div className="md:col-span-9 print:col-span-9">
                                <span className={`block text-[10px] font-bold uppercase tracking-wider mb-2 text-slate-400 print:text-slate-500`}>
                                    Meta
                                </span>
                                <p className="text-lg font-medium text-slate-800 leading-relaxed print:text-base print:text-black">
                                    {item.what || "Sin definir"}
                                </p>
                                </div>

                                {/* Columna: CUÁNDO */}
                                <div className="md:col-span-3 print:col-span-3 flex md:justify-end print:justify-end mt-2 md:mt-0">
                                <div className="flex flex-col md:items-end">
                                    <span className="flex items-center gap-1 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 print:text-slate-500">
                                    <Calendar size={12} />
                                    </span>
                                    <span className="inline-block md:block text-sm font-bold text-slate-600 bg-slate-50 border border-slate-100 px-3 py-1 rounded-lg print:border-slate-200 print:bg-white print:text-black print:px-0 print:py-0 print:border-0 print:text-right">
                                    {item.when || "Sin fecha"}
                                    </span>
                                </div>
                                </div>

                            </div>
                            </div>
                        ))}
                    </div>
                </div>
              </section>
            );
          })}

          {/* Mensaje si no hay nada pendiente en ninguna área */}
          {Object.values(data).every((area: AreaData) => area.items.filter(i => !i.isCompleted).length === 0) && (
            <div className="text-center py-24 border-2 border-dashed border-slate-700 rounded-3xl bg-slate-800/50 print:border-slate-300 print:bg-transparent print:text-black">
              <p className="text-slate-400 font-medium text-lg print:text-black">No hay metas pendientes en el plan actualmente.</p>
              <p className="text-slate-500 text-sm mt-2 print:text-slate-600">¡Buen trabajo completando tus objetivos!</p>
            </div>
          )}
        </div>

        {/* Pie de página para impresión */}
        <footer className="hidden print:block fixed bottom-0 left-0 w-full text-center py-4 border-t border-gray-200 mt-8 bg-white">
          <p className="text-[10px] text-gray-400 uppercase tracking-widest">
            Estaca Primavera — Plan Misional
          </p>
        </footer>

      </div>

      <style>{`
        @media print {
          @page {
            size: auto;
            margin: 10mm;
          }
          /* Forzar fondo blanco y texto negro en todo el documento */
          html, body {
            background-color: white !important;
            color: black !important;
            height: auto !important;
            overflow: visible !important;
          }
          /* Resetear estilos del contenedor raíz de React */
          #root {
            background-color: white !important;
            color: black !important;
            display: block !important;
            height: auto !important;
            overflow: visible !important;
          }
          /* Fuerza el fondo blanco eliminando cualquier estilo oscuro heredado */
          div[class*="bg-slate-900"],
          .bg-slate-900 {
            background-color: white !important;
            background-image: none !important;
            color: black !important;
          }
          /* Asegura que los gráficos de fondo (degradados de encabezados) se impriman */
          * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
        }
      `}</style>
    </div>
  );
};

export default PlanPreview;
